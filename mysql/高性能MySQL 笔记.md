# 高性能MySQL 笔记

## MySQL架构历史

> MySQL服务器逻辑架构图

### 逻辑架构

最上层为连接处理，授权认证，安全处理等

第二层为核心功能，包括查询解析、分析、优化、缓存以及所有的内置函数

第三层包含了存储引擎

![image-20201128093759874](https://gitee.com/chen_yi_fenga/blog-imag/raw/master/image-20201128093759874.png)

**连接管理和安全性**

连接需要基于用户名和主机信息及密码进行验证，使用**SSL**方式连接。

客户端连接成功，服务器会验证该客户端是否具有执行某个特定的查询语句的权限。

**优化与执行**

MySQL会解析查询语句，并创建内部数据结构（解析树）进行各种优化。

可以使用优化器解释(explain)查看优化过程的各个因素。

对于**SELECT**语句，会在解析开始前先查询缓存，如果缓存存在则直接返回缓存结果。

### 并发控制

**读写锁**

**读锁:**读锁是共享的，不互相阻塞。

**写锁:**写锁是排他的，写锁会阻塞其他的读锁和写锁。



**颗粒度**

**表锁:**锁住整张表，用户在对表进行写操作时，需要获取写锁。会阻塞其他读写操作。

**行锁:**最大程度支持并发处理，但是带来了锁开销。

### 事务

>  事务内的语句，要么全部执行， 要么全部不执行。

**ASIC**即原子性，一致性，隔离性，持久性。

**事务隔离级别:**

read uncommitted 读未提交

read commit 读已提交

repeatable read 可重复读  （默认的隔离级别）

serializable  串行化

### 多版本并发控制

MySQL大多数的事务形存储引擎实现的都不是简单的行级锁，一般都实现了多版本并发控制（**MVCC**）

**MVCC：**MVCC是通过保存数据某一时间的快照实现的。也就是说，不管需要执行多长时间，每个事务看到的数据都是一致的。根据事务开始的时间的不同，每个事务对同一张表、同一时间可能看到不同的数据。

![image-20201128150155536](https://gitee.com/chen_yi_fenga/blog-imag/raw/master/image-20201128150155536.png)

### 总结

![image-20201128150315210](https://gitee.com/chen_yi_fenga/blog-imag/raw/master/image-20201128150315210.png)

## 创建高性能的索引

### 索引的类型

> 索引是在存储引擎层 而不是服务层实现的。所以没有同一的索引标准

**B-Tree 索引**

存储引擎以不同的方式使用B-Tree索引，性能也有不同

**MyISAM**使用前缀压缩技术使得索引更小，索引通过数据的物理位置引用被索引的行。

**InnoDB**则按原数据格式进行存储。 根据主键引用被索引的行。

![image-20201128155213536](https://gitee.com/chen_yi_fenga/blog-imag/raw/master/image-20201128155213536.png)

索引多个值的排序是按照创建表语句的顺序定义的。

![image-20201128160225496](https://gitee.com/chen_yi_fenga/blog-imag/raw/master/image-20201128160225496.png)